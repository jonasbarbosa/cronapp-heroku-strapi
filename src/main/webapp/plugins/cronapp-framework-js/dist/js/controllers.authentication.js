(function(){angular.module("custom.controllers",[]);var a=function(b,c,d){b({method:"GET",url:"auth/refresh"}).success(function(e){localStorage.setItem("_u",JSON.stringify(e)),setTimeout(function(){a(b,c,d)},1800000),c()}).error(function(){d()})};app.controller("LoginController",["$controller","$scope","$http","$rootScope","$window","$state","$translate","Notification","ReportService","UploadService","$location","$stateParams","$timeout",function(b,c,d,e,f,g,h,i,j,k,l,m,n){function o(a){"undefined"!=typeof Storage&&(localStorage.setItem("_u",JSON.stringify(a)),e.session=JSON.parse(localStorage._u)),g.go("home"),c.blockly&&c.blockly.events&&c.blockly.events.onLogin&&c.blockly.events.onLogin instanceof Function&&c.blockly.events.onLogin()}function p(a,b){var c;c=401===b?h.instant("Login.view.invalidPassword"):403===b?h.instant("Admin.view.Access Denied"):a,i.error(c)}c.$http=d,c.params=m,app.registerEventsCronapi(c,h),e.http=d,e.Notification=i,e.UploadService=k,e.getReport=function(a,b,c){j.openReport(a,b,c)};var q=l.search();for(var r in q)q.hasOwnProperty(r)&&(c.params[r]=q[r]);c.autoLogin=function(){localStorage.getItem("_u")&&JSON.parse(localStorage.getItem("_u")).token&&a(d,function(){g.go("home")},function(){localStorage.removeItem("_u")})},c.autoLogin(),c.message={},c.renderRecaptcha=function(){window.grecaptcha.render("loginRecaptcha"),window.grecaptcha.reset()},c.login=function(a,b,e){if(c.message.error=void 0,$("form").children("*[class=g-recaptcha]").length&&(c.captcha_token=window.grecaptcha.getResponse(),""!==!c.captcha_token))return void window.grecaptcha.execute(function(){}).then(function(){angular.element($("form[ng-submit=\"login()\"]")[0]).scope().login()},function(){i.error("Error on recaptcha")});var f={username:a?a:c.username.value,password:b?b:c.password.value,recaptchaToken:c.captcha_token?c.captcha_token:void 0},g={"Content-Type":"application/x-www-form-urlencoded"};e&&(g["X-AUTH-TOKEN"]=e),d({method:"POST",url:"auth",data:$.param(f),headers:g}).success(o).error(p)};try{var s=b("AfterLoginController",{$scope:c});app.copyContext(s,this,"AfterLoginController")}catch(a){}n(function(){c.blockly&&c.blockly.events&&c.blockly.events.afterLoginRender&&c.blockly.events.afterLoginRender instanceof Function&&c.blockly.events.afterLoginRender()})}]),app.controller("HomeController",["$controller","$scope","$http","$rootScope","$state","$translate","Notification","ReportService","UploadService","$location","$stateParams","$timeout",function(b,c,d,e,f,g,h,i,j,k,l,m){c.$http=d,c.params=l,app.registerEventsCronapi(c,g),e.http=d,e.Notification=h,e.UploadService=j,e.getReport=function(a,b,c){i.openReport(a,b,c)};var n=k.search();for(var o in n)n.hasOwnProperty(o)&&(c.params[o]=n[o]);c.message={},c.selecionado={valor:1},e.session=localStorage.getItem("_u")===void 0?null:JSON.parse(localStorage.getItem("_u")),e.session?(e.myTheme="",e.session.user&&(e.myTheme=e.session.user.theme),c.$watch("myTheme",function(a){a!==void 0&&""!==a&&$("#themeSytleSheet").attr("href","plugins/cronapp-framework-js/css/themes/"+a+".min.css")}),localStorage.getItem("_u")&&JSON.parse(localStorage.getItem("_u")).token&&a(d,function(){},function(){localStorage.removeItem("_u"),f.go("login")})):!c.ignoreAuth&&(localStorage.removeItem("_u"),window.location.href=""),e.logout=function(){function a(){e.session={},"undefined"!=typeof Storage&&localStorage.removeItem("_u"),window.location.href=""}d({method:"GET",url:"logout",headers:{"Content-Type":"application/json"}}).success(a).error(a)},c.changePassword=function(){function a(){h.info(g.instant("Home.view.passwordChanged")),c()}function b(a,b){var c;c=422===b?a:401<=b?g.instant("Home.view.InvalidPassword"):a,h.error(c)}function c(){oldPassword.value="",newPassword.value="",newPasswordConfirmation.value="",$("#modalPassword").modal("hide")}if(function(){return""!==oldPassword.value&&""!==newPassword.value&&""!==newPasswordConfirmation.value||(""===newPasswordConfirmation.value&&h.error(g.instant("Home.view.ConfirmationPasswordCanNotBeEmpty")),""===newPassword.value&&h.error(g.instant("Home.view.NewPasswordCanNotBeEmpty")),""===oldPassword.value&&h.error(g.instant("Home.view.PreviousPasswordCanNotBeEmpty")),!1)}()){var e={oldPassword:oldPassword.value,newPassword:newPassword.value,newPasswordConfirmation:newPasswordConfirmation.value};d({method:"POST",url:"changePassword",data:$.param(e),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(a).error(b)}};var p=function(){var a=$(this);0<a.closest(".sub-menu").length&&a.closest(".navbar-nav").collapse("hide")};c.$on("$viewContentLoaded",function(){var a=$(".navbar-nav");a.off("click","a",p),a.on("click","a",p)}),c.themes=["material","cerulean","cosmo","cyborg","darkly","flatly","journal","lumen","paper","readable","sandstone","simplex","slate","spacelab","superhero","united","yeti"],c.changeTheme=function(a){if(a!==void 0){$("body").append("<div id=\"transition\" />"),$("#transition").css({"background-color":"#FFF",zIndex:1e5,position:"fixed",top:"0px",right:"0px",bottom:"0px",left:"0px",overflow:"hidden",display:"block"}),$("#transition").fadeIn(800,function(){$("#themeSytleSheet").attr("href","plugins/cronapp-framework-js/css/themes/"+a+".min.css"),e.myTheme=a,$("#transition").fadeOut(1e3,function(){$("#transition").remove()})});d({method:"POST",url:"changeTheme",data:$.param({theme:a}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(){e.session.theme=a,e.session.user.theme=a,localStorage.setItem("_u",JSON.stringify(e.session))}).error(function(a){h.error(a)})}};try{var q=b("AfterHomeController",{$scope:c});app.copyContext(q,this,"AfterHomeController")}catch(a){}m(function(){c.blockly&&c.blockly.events&&c.blockly.events.afterHomeRender&&c.blockly.events.afterHomeRender instanceof Function&&c.blockly.events.afterHomeRender()})}]),app.controller("PublicController",["$controller","$scope",function(a,b){b.ignoreAuth=!0,angular.extend(this,a("HomeController",{$scope:b}))}]),app.controller("SocialController",["$controller","$scope","$location",function(a,b,c){b.checkSocial=!0,angular.extend(this,a("LoginController",{$scope:b}));var d=c.search(),e={};for(var f in d)d.hasOwnProperty(f)&&(e[f]=d[f]);b.login("#OAUTH#","#OAUTH#",e._ctk)}])})(app),window.safeApply=function(a){var b=this.$root.$$phase;"$apply"===b||"$digest"===b?a&&"function"==typeof a&&a():this.$apply(a)};